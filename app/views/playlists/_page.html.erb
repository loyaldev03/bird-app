<div class="playlist-header">
  <%= link_to "", "#",
              data: { 
                source_type: source_type, 
                source_id: source_id,
                virtual: true
              }, 
              class: "play-#{source_type}-#{source_id} playlist-play-playlist",
              remote: true %>

  <%= render 'tracks/covers', object: tracks %>

  <% if @playlist.present? %>
    <div class="playlist-title">
      <%= @playlist.name %>
    </div>

    <div class="playlist-owner">
      <%= @playlist.user.name %>
    </div>
  <% end %>
</div>
<table class="playlist-items">
  <tr>
    <th></th>
    <th>Title</th>
    <th>Artist</th>
    <th>Release</th>
    <th class="text-center"><%= image_tag 'icons/time.png' %></th>
    <th>Rate</th>
    <th></th>
  </tr>
  <% for _track in tracks %>
    <% track = TrackPresenter.new(_track, current_user) %>
    <tr class='playlist-item'>
      <td style="white-space: nowrap;">
        <% if @playlist.present? %>
          <%= link_to "", "#", 
              class: "play-#{source_type}-#{source_id}-index-#{tracks.map(&:id).index(track.id)} playlist-play-track",
              data: { 
                source_type: source_type, 
                source_id: source_id, 
                track_index: tracks.map(&:id).index(track.id),
                virtual: true
              },
              remote: true %>
        <% else %>
          <%= link_to "", "#", 
              class: "play-#{source_type}-#{source_id}-track-#{track.id} playlist-play-track",
              data: { 
                source_type: source_type, 
                source_id: source_id, 
                track_index: tracks.map(&:id).index(track.id),
                track_id: track.id,
                virtual: true
              },
              remote: true %>
        <% end %>
        
        <button class="playlist-add-track" data-track-id="<%= track.id %>">+</button>
      </td>
      <td><%= track.title %></td>
      <td><%= track.artists %></td>
      <td>
        <%= link_to track.release, class: "release-link" do %>
        <%= track.release.title %>
        <%= track.release.title %>
        <% end %>
      </td>
      <td>Time</td>
      <td>
        <% unless current_user && current_user.has_role?(:artist) %>
          <%= rating_for track, 'main', star: 4, cancel: true, 
              disable_after_rate: false, star_path: '/images/rate/egg' %>
          &nbsp;
        <% end %>
        <%= track.average('main').try(:avg).try(:round,1) %>
      </td>
      <td style="position: relative;">
        <% if track.user_allowed?(current_user) %>
          <button class="playlist-download-track" type="button" data-toggle="collapse" data-target="#download-<%= track.id %>" aria-expanded="false" aria-controls="collapseExample">
            <%= image_tag('icons/icon-download.png') %>
          </button>
        <% end %>
        <div id="download-<%= track.id %>" class="collapse collapse-formats">
            <% track.download_uris.each do |format, uri| %>
              <a href="<%= uri %>" class="btn btn-danger"><%= format %></a>
            <% end %>
        </div>
      </td>
    </tr>
  <% end %>
</table>
