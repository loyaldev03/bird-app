<div class="release-present">
  <%= image_tag(@release.avatar.url, class: "release-avatar left-avatar") %>
  <%= link_to '', "#",
              data: { 
                source_type: 'release', 
                source_id: @release.id,
                virtual: true
              }, 
              class: "play-release-#{@release.id} playlist-play-playlist release-avatar release-play",
              remote: true %>

  <div class="release-bgrd">
    <%#= image_tag 'dj.jpg' %>

    <div class="release-header">
      <% if @release.exclusive? %>
        <div class="release-exclusive">
          <%= image_tag 'icons/user-logo-icon.svg' %>
          <div>ONLY ON<br>
          BIRDFEED</div>
        </div>
      <% end %> 

      <div class="release-likes">
        <%= render partial: 'likes/like_button', locals: { object: @release,  style: 'release' } %>
      </div>

      <div class="release-rate" data-release-id="<%= @release.id %>">
        RATE
        <% unless (current_user && current_user.has_role?(:artist)) %>
          <%= @release.average('main').try(:avg).try(:round,1) %>
          <%= rating_for @release, 'main', 
              star: 4, 
              readonly: true, 
              cancel: false,
              star_on: image_path('rate/egg/star-on.png'), 
              star_half: image_path('rate/egg/star-on.png'), 
              star_off: image_path('rate/egg/star-off.png')
            %>
        <% end %>
      </div>

      <%= render partial: 'layouts/share', locals: { object: @release, icon: 'white' } %>

      <% if @release.download_uris.any? %>
        <button class="release-icon" type="button" data-toggle="collapse" data-target=".release-<%= @release.id %>-download" aria-expanded="false" aria-controls="collapseExample">
          <%= image_tag('icons/icon-download.svg', title: "Download full release") %>
        </button>

        <div class="collapse collapse-formats release-<%= @release.id %>-download">
          <% @release.download_uris.each do |format, uri| %>
            <a href="<%= uri %>" class="btn btn-danger"><%= format %></a>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="release-info">
      <h1><%= @release.title.upcase %></h1>
      <div class="release-date">Catalog#: <%= @release.catalog %></div>
      <p class="release-date">Release date: <%= time_ago_in_words( @release.release_date ) %> ago</p>

      <div class="truncated-description">
        <% if @release.text.present? %>
          <article><%= strip_tags(@release.text).gsub('&amp;','&').truncate(400) %></article>

          <% if @release.text.html_safe.truncate(400) != @release.text.html_safe %>
            <a href="#" class="truncated-long">Read more</a>
          <% end %>

          <article><%= @release.text.html_safe %></article>
          <a href="#" class="truncated-short"><br><br>Read less</a>
        <% end %>
      </div>

      
      <%#= link_to "Q&A", chirp_path, class: "btn c-btn-transparent btn-wide" %>
    </div>

    <div class="user-controls">
      <div class="c-btn-group d-inline-block mr-4">
        <% release = params[:player].blank? %>
        <% classes = ["btn btn-wide c-btn-blue", "btn btn-wide c-btn-black btn-disabled"] %>
        <%= link_to "Feed", @release, 
            class: release ? classes[1] : classes[0] %><!--
       --><%= link_to "Music", 
            release_path(
              id: @release.id, 
              user_id: current_user.try(:id),
              player: true), 
            class: release ? classes[0] : classes[1] %>
      </div>
    </div>

    <%= render 'releases/release_feed' if defined?(release_feed) %>
  </div>

  <div class="col-md-4">
    <div class="sticky-top">

      <!-- ARTISTS -->
      <div class="c-panel bg-dark mb-4">
        <div class="c-flag c-flag-inner mb-2"><span class="t-blue">ARTISTS</span></div>

        <ol class="users-block list-unstyled mt-1 release-users-block">
          <% if @release.artist_as_string && @release.artist.present? %>
            <p><%= @release.artist %></p>
          <% elsif @release.users.any? %>
            <% @release.users.each do |artist| %>
              <li>
                <%= link_to artist_path(artist), class: "d-inline-block align-middle" do %>
                  <%= image_tag artist.avatar.thumb, class: "user-avatar" %>
                <% end %>

                <div class="user-subtitle">
                  <h5>
                    <%= link_to artist.name, artist_path(artist) %>
                    <%= image_tag 'icons/point-green.svg', class: "point-green" if artist.online? %>
                  </h5>
                  <div>
                    <%= link_to "All tracks", artist %>
                    /
                    <b><%= link_to "Artist Q & A", chirp_index_path %></b>
                  </div>
                </div>

                <%= render partial: 'follows/follow_button', 
                    locals: { object: artist, 
                              opt: { 
                                  classes: "btn c-btn-blue",
                                  text: ['follow', 'following'] } } %>
              </li>
            <% end %>

            <% if @release.users.count > 2 %>
              <div class="more-users">
                <span style="display: none;">Hide</span>
                <span>
                  & <%= @release.users.count - 2 %>
                  other 
                  <%= "artist".pluralize(@release.users.count - 2) %>
                </span>
              </div>
            <% end %>
          <% elsif @release.artist.present? %>
            <p><%= @release.artist %></p>
          <% elsif @release.tracks.any? %>
            <p><%= @release.tracks.pluck(:artist).try(:uniq).try(:join,', ') %></p>
          <% end %>
        </ol>
      </div>

      <!-- TRACKS -->
      <% if @release.tracks.any? %>
        <div class="c-panel bg-white">
          <div class="c-flag c-flag-inner mb-2">TRACKS ON THIS RELEASE</div>

          <ol class="list-unstyled mt-1">
            <%= render @release.tracks %>
          </ol>
        </div>
      <% end %>
    </div>
  </div>
</div>

